<div class="d-flex flex-wrap justify-content-between align-items-center text-white p-3 gap-2  ">

  <!-- Search Form -->
  <form action="/weather" method="GET" class="row g-2 flex-grow-1 mb-2 mb-md-0">
    <div class="col-12 col-md-6  ">
      <input type="text" name="city" class="form-control" placeholder="Enter city name..." required>
    </div>
    <div class="col-12 col-md-4">
      <button class="btn btn-primary w-100">Search</button>
    </div>
  </form>

  <!-- Use Location Button -->
  <div class="col-12 col-md-auto">
    <button class="btn btn-success w-100" onclick="getLocation()">
      üìç Use My Location
    </button>
  </div>

</div>
<hr>

<% if (weather) { %>
<h4><%= city %> 7-Day Forecast</h4>

<div class=" row p-3 gap-5 justify-content-center justify-content-md-between">
  <% weather.time.forEach((day, index) => { 
       let code = 0;  
       if (weather.daily && Array.isArray(weather.daily.weathercode) && weather.daily.weathercode[index] != null) {
           code = weather.daily.weathercode[index];
       }
  %>
    <div class="col-12 col-sm-6  col-md-4 col-lg-3      text-center  bg-danger text-white rounded" data-code="<%= codes[index] %>">
      <h6><%= day %></h6>
      <i id="jiu-<%= index %>" class="wi" data-code="<%= codes[index] %>"></i>
      <span class="weather-text d-block " id="text-<%= index %>"></span>
      <p class="mt-2">üå° <%= weather.temperature_2m_min[index] %>¬∞ - <%= weather.temperature_2m_max[index] %>¬∞</p>
    </div>
  <% }) %>
</div>
<% } %>

<script src="/weather/javascript/weatherCodeToIcon.js"></script>

<script>
document.querySelectorAll("i.wi").forEach(iconEl => {
  const code = parseInt(iconEl.dataset.code);
  const { icon, text } = weatherCodeToIconAndText(code);

  iconEl.className = `wi ${icon}`;
  const textEl = document.getElementById("text-" + iconEl.id.split("-")[1]);
  if (textEl) {
    textEl.textContent = text;
    textEl.style.color = "red";
  }
});
</script>

<% if (weather) { %>
<hr>
<h4 class="mt-4">üå° 7-Day Temperature Trend</h4>

<canvas id="tempChart" class="w-100" style="max-width:100%;"></canvas>

<script>
  const labels = <%- JSON.stringify(weather.time) %>;
  const maxTemps = <%- JSON.stringify(weather.temperature_2m_max) %>;
  const minTemps = <%- JSON.stringify(weather.temperature_2m_min) %>;

  const ctx = document.getElementById("tempChart").getContext("2d");

  new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Max Temp",
          data: maxTemps,
          borderColor: "red",
          backgroundColor: "rgba(255,0,0,0.2)",
          tension: 0.4
        },
        {
          label: "Min Temp",
          data: minTemps,
          borderColor: "blue",
          backgroundColor: "rgba(0,0,255,0.2)",
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: "top" } },
      scales: { y: { beginAtZero: false } }
    }
  });
</script>
<% } %>

<script>
function getLocation() {
  if (!navigator.geolocation) {
    alert("Your browser does not support geolocation!");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    function(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      window.location.href = `/weatherByLocation?lat=${lat}&lon=${lon}`;
    },
    function(error) {
      console.error("User denied geolocation or it failed", error);
      alert("Unable to retrieve location");
    }
  );
}
</script>
